<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.inovel.mapper.BookMapper">

<select id="findAll" resultType="com.inovel.entity.Book">
    SELECT * FROM book WHERE visibility = 'public' AND status = 1 ORDER BY create_time DESC
</select>

<select id="findById" parameterType="long" resultType="com.inovel.entity.Book">
    SELECT * FROM book WHERE id = #{id}
</select>

<select id="findByCategory" parameterType="string" resultType="com.inovel.entity.Book">
    SELECT * FROM book WHERE category = #{category} AND visibility = 'public' AND status = 1 ORDER BY create_time DESC
</select>

<select id="searchByKeyword" parameterType="string" resultType="com.inovel.entity.Book">
    SELECT * FROM book
    WHERE (title LIKE CONCAT('%', #{keyword}, '%')
    OR author LIKE CONCAT('%', #{keyword}, '%'))
    AND visibility = 'public' AND status = 1
    ORDER BY create_time DESC
</select>

<insert id="insert" parameterType="com.inovel.entity.Book" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO book (title, author, cover, category, description, file_path, file_type, upload_user_id, visibility, status)
        VALUES (#{title}, #{author}, #{cover}, #{category}, #{description}, #{filePath}, #{fileType}, #{uploadUserId}, #{visibility}, #{status})
</insert>


<update id="update" parameterType="com.inovel.entity.Book">
    UPDATE book
    SET title=#{title}, author=#{author}, cover=#{cover}, category=#{category}, description=#{description},
    file_path=#{filePath}, file_type=#{fileType}, status=#{status}
    WHERE id=#{id}
</update>

<delete id="delete" parameterType="long">
    DELETE FROM book WHERE id=#{id}
</delete>
<select id="findByCategoryAndKeyword" resultType="com.inovel.entity.Book">
        SELECT *
        FROM book
        WHERE category = #{category}
          AND (title LIKE CONCAT('%', #{keyword}, '%')
            OR author LIKE CONCAT('%', #{keyword}, '%'))
          AND visibility = 'public' AND status = 1
        ORDER BY create_time DESC
</select>
    <!-- 根据书籍ID列表和关键字查询 -->
    <select id="findByIdsAndKeyword" resultType="com.inovel.entity.Book">
        SELECT *
        FROM book
        WHERE id IN
        <foreach item="id" collection="bookIds" open="(" separator="," close=")">
            #{id}
        </foreach>
        <if test="keyword != null and keyword != ''">
            AND title LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>

    <!-- 根据书籍ID列表查询 -->
    <select id="findByIds" resultType="com.inovel.entity.Book">
        SELECT *
        FROM book
        WHERE id IN
        <foreach item="id" collection="bookIds" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
</mapper>
